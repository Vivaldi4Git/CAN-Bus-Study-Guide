# 什么是NMT?
网络管理（Network Management，简称NMT）是CANopen协议中的一个核心组件，用于控制和监视网络中设备的操作状态。

# NMT节点
在CANopen网络中，被NMT管理的对象称为"节点"。节点是指连接到CANopen网络的任何设备或系统。

## 节点状态
![](attachments/Pasted%20image%2020241022151137.png)

节点状态如下：
- 初始化：开启后，节点经过这个状态。此时，设备应用程序和设备通信（比特率和节点地址）被初始化。之后，节点独立切换到"预操作"状态。
- 预操作：可以通过 SDO 与节点通信。但是，节点不能执行 PDO 通信。
- 运行：CANopen 节点完全运行。它可以独立发送和接收过程数据。
- 已停止：节点与网络完全分离。无法进行 SDO 和 PDO 通信。节点只能通过相应的网络命令（例如：启动节点）才能更改为另一种网络状态。

## NMT节点上线报文
当CANopen节点完成初始化并准备进入网络时，它会发送一个上线报文（也称为启动消息或Boot-up message）。节点上线报文的 ID 为 700h+Node-ID，数据为 1 个字节0。生产者为 CANopen 从站。
![](attachments/Pasted%20image%2020241012133343.png)

CAN上的报文是以广播形式发送的，因此所有节点都会收到这个报文。但只有 CANopen 主站可以处理这个报文。
通常在节点上电或重置后发送。

## NMT 节点状态与心跳报文
为了监控 NMT 节点是否在线与目前的节点状态。CANopen 应用中通常都要求在线上电的从站定时发送状态报文（心跳报文），以便于主站确认从站是否故障、是否脱离网络。

心跳报文还会通过数据段"汇报"节点状态，CANID与节点上线报文相同为700h+Node-ID。数据为1 个字节，代表节点目前的状态，04h为停止状态，05h为操作状态，7Fh为预操作状态。
![](attachments/Pasted%20image%2020241012135116.png)

CANopen 从站按其对象字典的 1017h 中填写的心跳生产时间（ms）进行心跳报文的发送，而 CANopen 主站（NMT 主站）则会按照 1016h 中填写的心跳消费时间进行检查，假设超过诺干次心跳消费时间没有收到从站的心跳报文，则认为从站已经离线或者损坏。

## NMT 节点守护
不使用，被心跳报文所取代。

## NMT 节点状态切换命令
NMT 节点状态切换命令就是用于切换 NMT 节点状态的命令。在CANopen网络中，NMT主站可以向从站发送节点状态切换命令，以控制从站进入不同的工作状态。
![](attachments/Pasted%20image%2020241012151119.png)

CANID 均为 000h，具备最高的 CAN 优先级。数据段为 2 个字节：
第1 个字节代表命令类型：
- 01h为启动命令（让节点进入操作状态）
- 02h为停止命令（让节点进入停止状态）
- 80h为进入预操作状态（让节点进入预操作状态）
- 81h为复位节点应用层（让节点的应用恢复初始状态，比如列车门都恢复打开状态）
- 82h为复位节点通讯（让节点的 CAN 和 CANopen 通讯重新初始化，一般用于总线收到干扰，导致节点总线错误被动，或者总线关闭时）

第二个字节代表被控制的节点Node-ID，如果要对整个网络所有节点同时进行控制，则这个数值为 0 即可。

我们已经了解了NMT如何管理节点状态。现在，让我们看看执行这些管理功能的设备——CANopen主站。

## CANopen主站
CANopen主站通常也是NMT主站,负责管理整个CANopen网络中的从站设备。

为了满足管理整个 CANopen 网络的从站设备，需要具备以下功能：
- 支持PDO（过程数据对象）和SDO（服务数据对象）的收发
- 执行NMT网络管理
- 管理PDO通信
- 执行LSS（层设置服务）功能
- 管理从站设备
- 处理紧急报文
- 支持CANopen标准指示灯功能

下面展示的是通用的CANopen设备模型，CANopen主站也遵循这个基本结构：
![](attachments/Pasted%20image%2020241012155045.png)

CANopen主站有两种形式：
- PLC
- PC扩展的CANopen主站通信卡

PC扩展的CANopen主站通信卡就像网卡一样，只不过连入的是CAN的网

# 参考资料
- [CANopen轻松入门（周立功）](CANopen轻松入门（周立功）.pdf)
- [CANopen 诊断 (helpme-codesys.com)](https://content.helpme-codesys.com/zh-CHS/CODESYS%20CANbus/_can_f_canopen_manager_diagnosis2.html)

# 下一章
- [CANopenPDO](CANopenPDO.md)
