在深入了解PDO之前，我们需要理解CANopen中数据传输的基本概念。
### 为什么需要数据传输？

在CANopen网络中，不同的设备（节点）需要相互通信以完成各种任务。例如：

- 传感器需要发送测量数据
- 控制器需要发送命令
- 执行器需要报告其状态

这种通信确保了整个系统的协调运作。
# 什么是PDO

PDO(Process Data Object)，过程数据对象。他是一个实时数据的快照。想象你在拍摄一个快速移动的物体，PDO就是那个瞬间捕捉到的图像。
他是用于传输实时数据的机制。PDO采用的是生产-消费模式。
假设我们有一个温度控制系统， PDO的结构可能如下：

```
温控系统PDO = {
    当前温度: 25.5°C,
    目标温度: 22.0°C,
    加热器状态: 开启,
    风扇速度: 中速
}
```

显然，这是温控系统在某一时刻的温度、目标温度、加热器状态和风扇速度的值。但不是温控系统的所有数据，也不是温控系统在某一时刻的所有数据。

我们知道对象字典是CANopen设备中存储所有配置和运行数据的中心数据库。

也就是说，数据字典的数据需要一个过滤。这个过滤的规则就是PDO映射。

# PDO的映射
PDO映射是一个精选过程，就像从书店中挑选最畅销的书籍。想象一下：

1. 书店（对象字典）：存有各种类型的书籍
2. 畅销书架（PDO）：只展示最受欢迎的几本书
3. 选书过程（PDO映射）：决定哪些书放在畅销书架上

假设我们的温控系统对象字典如下：

```
对象字典 = {
    1000h: 设备类型,
    1001h: 错误寄存器,
    2100h: 当前温度,
    2101h: 目标温度,
    2102h: 加热器状态,
    2103h: 风扇速度,
    // ... 更多条目
}

PDO映射 = {
    1. 2100h (当前温度)
    2. 2101h (目标温度)
    3. 2102h (加热器状态)
    4. 2103h (风扇速度)
}
```

这个映射确保了只有最关键、最常用的数据会通过PDO传输。

# PDO的传输方式
在传输PDO时，我们要为不同程度的"实时"需求提供合适的解决方案，同时考虑到系统的其他约束和需求。

1. 异步传输
   - 事件触发
   - 远程请求

2. 同步传输
   - 循环传输
   - 非循环传输

## 事件触发

事件触发就是一有变化就立即通知。这种方式能够实时反映系统状态的变化，非常适合对时效性要求较高的应用场景。

想象一个精密温控系统，温度微小变化需立即报告。

在这里，事件触发就是温度变化。传感器就是生产者，它负责检测温度变化并发送数据。而接收这些数据的设备，比如控制器或显示器，就是消费者。

事件触发的优点是能够及时反映系统状态，减少不必要的数据传输。但是，如果变化频繁发生，可能会导致网络负载增加。因此，在实际应用中，通常会设置一个阈值或时间间隔，只有当变化超过某个范围或经过一定时间后才触发传输，以平衡实时性和网络负载。

## 远程请求

远程请求是一种按需获取数据的方法。在这种模式下，消费者主动向生产者请求数据。

想象一个大型建筑的温度管理系统。中央控制室（消费者）可能只在特定时刻需要某个区域的温度数据。此时，它会向该区域的温度传感器（生产者）发送一个请求，传感器收到请求后才会发送当前的温度数据。

远程请求的优点是可以减少不必要的数据传输，只在真正需要数据时才进行通信。这可以有效降低网络负载，特别是在大型系统中。然而，这种方式可能不适合需要持续监控或快速响应的场景。

## 循环传输

循环传输是一种定期、可预测的数据更新方式。在这种模式下，PDO会按照固定的时间间隔进行传输。

考虑一个工业冷却系统，需要定期监控多个点的温度。系统可能设置为每分钟同时采集所有温度传感器的数据。这就是一个典型的循环传输场景。

循环传输的优点是提供了稳定、可预测的数据流，便于系统进行整体规划和资源分配。但是，如果设置的周期过短，可能会产生大量冗余数据；如果周期过长，则可能错过重要的状态变化。

## 非循环传输
非循环传输结合了同步信号和事件触发的特点。在这种模式下，PDO的传输需要同时满足接收到同步信号和特定事件发生这两个条件。

想象一个智能家居温控系统。系统可能每5分钟发送一次同步信号，但温度传感器只在检测到温度变化超过0.5°C且收到同步信号时才发送数据。

这种方式的优点是既保证了一定的周期性检查，又避免了在没有显著变化时的不必要传输。它特别适合那些需要周期性监控，但大部分时间状态相对稳定的系统。

选择哪种PDO传输方式，需要根据具体应用场景的需求，考虑实时性要求、数据变化频率、网络负载、系统复杂性等因素。在实际应用中，可能会综合使用多种传输方式，以获得最佳的系统性能。

PDO的传输方式图：
![](attachments/Pasted%20image%2020241015142701.png)

# PDO的通信参数

## 什么是通信参数？
PDO通信参数是一组配置选项，用于定义PDO（过程数据对象）如何在CANopen网络中传输，包括何时发送、如何发送以及发送的频率等。

![](attachments/Pasted%20image%2020241015154110.png)

1. Number of entries 参数条目数量：即本索引中有几条参数
2. COB-ID （Communication Object Identifier 通信对象标识符）
显然他是PDO的id。那他和CAN-ID有什么关系？
COB-ID是CANopen协议层面的概念，CAN-ID是CAN协议层面的概念。COB-ID的低位部分就是实际使用的CAN-ID。
3. Transmission Type 传输类型
也就是前面提到的PDO的传输方式。
4. Inhibit Time 禁止时间
其实就是两次PDO传输的最小时间间隔。它是强制性的，或者说优先级较高，即使有新的事件触发，系统也必须遵守这个最小间隔时间。
5. Event Timer 事件计时器，用于设置PDO自动发送的最大间隔，确保数据定期更新。
6. SYNC start value 同步起始值，同步传输的PDO，收到诺干个同步包后，才进行发送，这个同步起始值就是同步包数量。比如设置为 2，即收到 2 个同步包后才进行发送。

# 下一章
[CANopenSDO](CANopenSDO.md)
